     1	package vm
     2
     3	import (
     4		"os"
     5		"path/filepath"
     6
     7		"howett.net/plist"
     8		"github.com/utmapp/vmtool/pkg/config"
     9	)
    10
    11	type UTMConfig struct {
    12		Information struct {
    13			Name string `plist:"Name"`
    14			UUID string `plist:"UUID"`
    15		} `plist:"Information"`
    16		System struct {
    17			Architecture string `plist:"Architecture"`
    18			Memory       int    `plist:"Memory"`
    19			CPUCount     int    `plist:"CPUCount"`
    20			Target       string `plist:"Target"`
    21		} `plist:"System"`
    22		Drives []struct {
    23			ImageName string `plist:"ImageName"`
    24			Interface string `plist:"Interface"`
    25			ImageType string `plist:"ImageType"`
    26		} `plist:"Drive"`
    27	}
    28
    29	func ImportUTM(bundlePath string) (*config.VMConfig, error) {
    30		configPath := filepath.Join(bundlePath, "config.plist")
    31		f, err := os.Open(configPath)
    32		if err != nil {
    33			return nil, err
    34		}
    35		defer f.Close()
    36
    37		var utmCfg UTMConfig
    38		decoder := plist.NewDecoder(f)
    39		if err := decoder.Decode(&utmCfg); err != nil {
    40			return nil, err
    41		}
    42
    43		vmCfg := &config.VMConfig{
    44			Name: utmCfg.Information.Name,
    45			UUID: utmCfg.Information.UUID,
    46			System: config.SystemConfig{
    47				Architecture: utmCfg.System.Architecture,
    48				Memory:       utmCfg.System.Memory,
    49				CPUs:         utmCfg.System.CPUCount,
    50				Target:       utmCfg.System.Target,
    51			},
    52			Display: config.DisplayConfig{
    53				Enabled: true,
    54				VNCAddr: ":0",
    55			},
    56		}
    57
    58		for i, d := range utmCfg.Drives {
    59			imagePath := filepath.Join(bundlePath, "Data", d.ImageName)
    60			vmCfg.Drives = append(vmCfg.Drives, config.DriveConfig{
    61				ID:        i,
    62				Interface: d.Interface,
    63				ImagePath: imagePath,
    64				ImageType: d.ImageType,
    65			})
    66		}
    67
    68		return vmCfg, nil
    69	}
